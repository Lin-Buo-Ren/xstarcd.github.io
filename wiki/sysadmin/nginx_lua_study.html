<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="Stylesheet" type="text/css" href="../styles/style.css" />
    <title>nginx_lua脚本学习</title>
</head>
<body>
<div id="header">
    <ul id="top-nav">
    <li><a href="../index.html">首页</a></li>
    <li><a href="index.html">分类首页</a></li>
    </ul>
</div>
<div id="cse"></div>
<div id="main">

<h1>nginx_lua脚本学习</h1>
<div class="toc">
<ul>
<li><a href="#toc_0.1">NgxLua执行过程</a>
<li><a href="#toc_0.2">基本操作</a>
</ul>
</ul>
</div>

<ul>
<li>
Lua简明教程: <a href="http://coolshell.cn/articles/10739.html">http://coolshell.cn/articles/10739.html</a>

<li>
Lua 5.1中文手册: <a href="http://manual.luaer.cn/">http://manual.luaer.cn/</a>

<li>
Lua程序设计: <a href="http://book.luaer.cn/">http://book.luaer.cn/</a>

<li>
lua-nginx: 

<ul>
<li>
<a href="https://github.com/openresty/lua-nginx-module">https://github.com/openresty/lua-nginx-module</a>

<li>
<a href="https://www.nginx.com/resources/wiki/modules/lua/">https://www.nginx.com/resources/wiki/modules/lua/</a>

</ul>
<li>
OpenResty最佳实践:<a href="https://moonbingbing.gitbooks.io/openresty-best-practices/content/">https://moonbingbing.gitbooks.io/openresty-best-practices/content/</a>

<li>
Ngx Lua入门: <a href="https://www.iteye.com/blog/jinnianshilongnian-2186448">https://www.iteye.com/blog/jinnianshilongnian-2186448</a>

<li>
由Lua 粘合的Nginx生态环境:

<ul>
<li>
<a href="https://blog.csdn.net/ygm_linux/article/details/53561176">https://blog.csdn.net/ygm_linux/article/details/53561176</a> 

<li>
 ngx_openresty: an Nginx ecosystem glued by Lua:

<ul>
<li>
<a href="http://agentzh.org/misc/slides/ngx-openresty-ecosystem/#1">http://agentzh.org/misc/slides/ngx-openresty-ecosystem/#1</a>

</ul>
<li>
章亦春 (agentzh)

<li>
<a href="http://agentzh.org/">http://agentzh.org/</a>

</ul>
</ul>

<h2 id="toc_0.1">NgxLua执行过程</h2>

<ul>
<li>
<a href="https://blog.csdn.net/ygm_linux/article/details/53534933">https://blog.csdn.net/ygm_linux/article/details/53534933</a>

</ul>

<p>
<img src="../img/lua/ngx_lua.jpg" width=800px>
</p>

<p>
ngx_lua属于nginx的一部分，它的执行指令都包含在nginx的11个步骤之中了，相应的处理阶段可以做插入式处理，即可插拔式架构，不过ngx_lua并不是所有阶段都会运行的；另外指令可以在http、server、server if、location、location if几个范围进行配置：
</p>

<table>
<tr>
<th>
指令
</th>
<th>
所处处理阶段
</th>
<th>
使用范围
</th>
<th>
解释
</th>
</tr>
<tr>
<td>
init_by_lua
</td>
<td rowspan="2">
loading-config
</td>
<td rowspan="2">
http
</td>
<td>
nginx Master进程加载配置时执行；
</td>
</tr>
<tr>
<td>
init_by_lua_file
</td>
<td>
通常用于初始化全局配置/预加载Lua模块
</td>
</tr>
<tr>
<td>
init_worker_by_lua
</td>
<td rowspan="2">
starting-worker
</td>
<td rowspan="2">
http
</td>
<td>
每个Nginx Worker进程启动时调用的计时器,如果Master进程不允许则只会在init_by_lua之后调用；
</td>
</tr>
<tr>
<td>
init_worker_by_lua_file
</td>
<td>
通常用于定时拉取配置/数据,或者后端服务的健康检查
</td>
</tr>
<tr>
<td>
set_by_lua
</td>
<td rowspan="2">
rewrite
</td>
<td rowspan="2">
server,server if,location,location if
</td>
<td rowspan="2">
设置nginx变量,可以实现复杂的赋值逻辑；此处是阻塞的,Lua代码要做到非常快；
</td>
</tr>
<tr>
<td>
set_by_lua_file
</td>
</tr>
<tr>
<td>
rewrite_by_lua
</td>
<td rowspan="2">
rewrite tail
</td>
<td rowspan="2">
http,server,location,location if
</td>
<td rowspan="2">
rrewrite阶段处理,可以实现复杂的转发/重定向逻辑；
</td>
</tr>
<tr>
<td>
rewrite_by_lua_file
</td>
</tr>
<tr>
<td>
access_by_lua
</td>
<td rowspan="2">
access tail
</td>
<td rowspan="2">
http,server,location,location if
</td>
<td rowspan="2">
请求访问阶段处理,用于访问控制
</td>
</tr>
<tr>
<td>
access_by_lua_file
</td>
</tr>
<tr>
<td>
content_by_lua
</td>
<td rowspan="2">
content
</td>
<td rowspan="2">
location,location if
</td>
<td rowspan="2">
内容处理器,接收请求处理并输出响应
</td>
</tr>
<tr>
<td>
content_by_lua_file
</td>
</tr>
<tr>
<td>
header_filter_by_lua
</td>
<td rowspan="2">
output-header-filter
</td>
<td rowspan="2">
http,server,location,location if
</td>
<td rowspan="2">
设置header和cookie
</td>
</tr>
<tr>
<td>
header_filter_by_lua_file
</td>
</tr>
<tr>
<td>
body_filter_by_lua
</td>
<td rowspan="2">
output-body-filter
</td>
<td rowspan="2">
http,server,location,location if
</td>
<td rowspan="2">
对响应数据进行过滤,比如截断、替换。
</td>
</tr>
<tr>
<td>
body_filter_by_lua_file
</td>
</tr>
<tr>
<td>
log_by_lua
</td>
<td rowspan="2">
log
</td>
<td rowspan="2">
http,server,location,location if
</td>
<td rowspan="2">
log阶段处理,比如记录访问量/统计平均响应时间
</td>
</tr>
<tr>
<td>
log_by_lua_file
</td>
</tr>
</table>

<h2 id="toc_0.2">基本操作</h2>

<pre class="brush:bash">
    location /echo {
        default_type 'text/plain';
        echo 'hello world';
    }

    location /luatest {
        default_type 'text/plain';
        content_by_lua '
        ngx.say("request_method:",ngx.var.request_method)
        local args = nil
        if ngx.var.request_method == "POST" then
            ngx.req.read_body()
            args = ngx.req.get_post_args()
        elseif ngx.var.request_method == "GET" then
            args = ngx.req.get_uri_args()
        else
            args = "no"
        end
        for key, val in pairs(args) do
            if type(val) == "table" then
                ngx.say(key, ": ", table.concat(val, ", "))
            else
                ngx.say(key, ": ", val)
            end
        end
        ';
    }

    location = /request_body {
        default_type 'text/plain';
        client_max_body_size 50k;
        client_body_buffer_size 50k;

        content_by_lua '
            ngx.req.read_body()  -- explicitly read the req body
            local data = ngx.req.get_body_data()
            if data then
                ngx.say("body data:")
                ngx.print(data)
                return
            end

            -- body may get buffered in a temp file:
            local file = ngx.req.get_body_file()
            if file then
                ngx.say("body is in file ", file)
            else
                ngx.say("no body found")
            end
        ';
    }
</pre>

</div>
<div id="footer">
<p>
&copy; 2012 - 2015 XStar
&nbsp;|&nbsp;<a href="http://code.google.com/p/vimwiki/" title="vimwiki">Powerby:Vimwiki</a>
&nbsp;|&nbsp;<a href="http://kwiki.github.io" title="丘迟">Style:丘迟</a>
&nbsp;|&nbsp;<a href="../index.html">首页</a>
&nbsp;|&nbsp;<a href="index.html">分类首页</a>
&nbsp;|&nbsp;<a href="../SiteMap.html">站点地图</a>
</p>
</div>
<script type="text/javascript">var vimwiki_rootpath="../";</script>
<script type="text/javascript" src="https://cdn.staticfile.org/jquery/2.0.0/jquery.min.js"></script>
<script type="text/javascript" src="../scripts/vimwiki.js"></script>
</body>
</html>

